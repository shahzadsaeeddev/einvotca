# Use a specific version of the base image to ensure consistency
FROM python:3.10-bullseye

# Set environment variable for Java Home
ENV JAVA_HOME /usr/lib/jvm/java-11-openjdk-amd64/
ENV PATH="/opt/venv/bin:$PATH"

# Install system dependencies and set up Python environment
# Grouping RUN commands and using --no-cache for apt-get improves cache usage and security
RUN apt-get update -y && \
    apt-get install -y --no-install-recommends default-jdk postgresql-client && \
    rm -rf /var/lib/apt/lists/* && \
    python3 -m venv /opt/venv && \
    /opt/venv/bin/pip install --upgrade pip

# Copy only the requirements.txt to leverage Docker cache
COPY requirements.txt /neksio/

# Install Python dependencies
RUN /opt/venv/bin/pip install -r /neksio/requirements.txt

# Copy the rest of the application code
COPY . /neksio

# Ensure the entrypoint script is executable
RUN chmod +x /neksio/entrypoint.sh

# Set the working directory
WORKDIR /neksio

# Run the entrypoint script
CMD ["/neksio/entrypoint.sh"]
